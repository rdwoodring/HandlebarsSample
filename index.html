<html>

    <head>
        <script src="handlebars.runtime-v4.0.4.js" type="text/javascript"></script>
        <script src="templates/templates.js" type="text/javascript"></script>
        <script src="jquery-2.1.4.min.js" type="text/javascript"></script>
    </head>

    <body>
        <div id="header-placeholder"></div>

        <a href="#" id="personButton">Show me a person!</a>
        <div class="tile">
          <div id="people-placeholder"></div>
        </div>
        <div class="tile">
          <div id="films-placeholder"></div>
        </div>

        <script type="text/javascript">
            renderTemplate(Handlebars.templates['header.hbs'], {'date' : new Date().toString()}, "#header-placeholder");

            $("#personButton").click(function() {
              getPerson();
            });


            function getPerson()
            {
              //var films =[];
              //var filmPromise;

              var promise = $.ajax({url: 'http://swapi.co/api/people/1/'});

              //TODO: show loading graphic

              promise.then(function() {
                renderTemplate(Handlebars.templates['people.hbs'], promise.responseJSON, "#people-placeholder", true);
              }).then(function() {
                for (var i = 0; i < promise.responseJSON.films.length; i++)
                {
                  getFilm(promise.responseJSON.films[i]);
                }
              });
            }

            function getFilm(film)
            {
              var promise = $.ajax({url: film});
              promise.then(function() {
                console.log(promise.responseJSON.title);
                renderTemplate(Handlebars.templates['films.hbs'], promise.responseJSON, "#films-placeholder", false);
              });
            }

            /*function getFilms(films)
            {
              var filmPromises = [];

              $.each(films, function() {
                var filmPromise = $.ajax({url: this});
                filmPromises.push(filmPromise);
              });
               $.when.apply($, filmPromises).done(function(promise) {
                 console.log(promise);
                 //console.log(promise[0].title);
                 //renderTemplate(Handlebars.templates['films.hbs'], promise.responseJSON, "#films-placeholder", false);
               });
            }*/

            function renderTemplate(template, contextData, placeholderId, overwrite = true)
            {
                var context = contextData;
                var html = template(context);

                if (overwrite)
                {
                  $(placeholderId).html(html);
                }
                else
                {
                  $(placeholderId).append(html);
                }
            }

            function apiRequest(apiEndpoint)
            {
                var dfd = new $.Deferred();

                $.ajax({
                    url: apiEndpoint
                })
                .done(function(status){
                    personData = result;
                    dfd.resolve(result);
                })
                .fail(function() {
                    $("#api-placeholder").html("Uh oh!  The Sarlaac must have eaten those results...");
                })
                .always(function() {
                    //add code
                });

                return dfd.promise();
            }
        </script>
    </body>
</html>
